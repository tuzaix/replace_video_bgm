# 视频拼接工具 (Video Concat Tool)

## 功能介绍

这个工具可以从指定目录中随机选择 n 个视频文件，将它们拼接成一个视频，然后替换背景音乐（BGM）。整个过程不进行视频转码压缩，以提高处理效率。

## 主要特性

- 🎲 **随机选择**: 从视频目录中随机挑选指定数量的视频
- 🔗 **稳定拼接**: 使用 ffmpeg concat demuxer 并重编码为 H.264，规范化时间戳与编码以避免卡顿
- 🎵 **两步合成**: 先生成临时拼接视频，再合成BGM（视频流直接复制、音频重编码）
- 🎵 **BGM替换**: 替换音频轨道为指定的背景音乐
- ⚡ **快速处理**: 视频流直接复制，只重编码音频部分
- 🎯 **可重现**: 支持随机种子，确保结果可重现

## 安装要求

- Python 3.7+
- FFmpeg (需要在 PATH 中或通过 `--ffmpeg-path` 指定)

## 使用方法

### 基本用法

```bash
python video_concat.py <视频目录> <BGM文件路径>
```

### 完整参数

```bash
python video_concat.py <视频目录> <BGM文件路径> [选项]
```

### 参数说明

- `video_dir`: 包含视频文件的目录路径
- `bgm_path`: BGM音频文件路径或音频目录路径（目录时随机选择）

#### 可选参数

- `-n, --count`: 每个输出随机选择的视频数量（默认: 5）
- `-m, --outputs`: 生成的随机拼接视频数量（默认: 5）
- `-o, --output`: 输出文件路径或目录（默认: 在视频目录同级创建 `_longvideo` 目录）
- `--ffmpeg-path`: 指定 ffmpeg 可执行文件路径

## 使用示例

### 示例 1: 基本使用
```bash
python video_concat.py "D:\Videos" "D:\Music\bgm.mp3"
```
从 `D:\Videos` 目录随机选择 5 个视频拼接，并替换为 `bgm.mp3`，输出到 `D:\Videos_longvideo\` 目录

### 示例 2: 指定视频数量
```bash
python video_concat.py "D:\Videos" "D:\Music\bgm.mp3" -n 10
```
随机选择 10 个视频进行拼接

### 示例 3: 指定输出路径
```bash
python video_concat.py "D:\Videos" "D:\Music\bgm.mp3" -n 8 -o "D:\Output\final_video.mp4"
```
选择 8 个视频拼接，输出到指定路径

### 示例 4: 使用BGM目录
```bash
python video_concat.py "D:\Videos" "D:\Music" -n 5
```
从 `D:\Videos` 目录随机选择 5 个视频，从 `D:\Music` 目录随机选择一首BGM进行拼接

## 随机种子

工具会自动生成基于时间戳和随机数组合的种子，确保每次运行都有不同的随机选择结果。生成的种子会在运行时显示，方便调试和记录。

## BGM处理逻辑

- 当拼接后的视频时长短于BGM时，自动截断BGM以匹配视频时长。
- 当拼接后的视频时长长于BGM时，自动循环播放BGM直至匹配视频时长。
- 技术实现：通过`-stream_loop -1`循环音频，并使用`-shortest`以视频长度为准。

## 支持的格式

### 视频格式
- MP4 (.mp4)
- MOV (.mov)
- MKV (.mkv)
- AVI (.avi)
- WebM (.webm)
- FLV (.flv)
- M4V (.m4v)

### 音频格式
- MP3 (.mp3)
- WAV (.wav)
- M4A (.m4a)
- AAC (.aac)
- FLAC (.flac)
- OGG (.ogg)

## 工作流程

1. **扫描目录**: 递归扫描指定目录，找到所有支持的视频文件
2. **随机选择**: 根据指定数量随机选择视频文件
3. **创建临时目录**: 自动创建 `视频目录名_temp` 临时目录
4. **创建拼接列表**: 生成 ffmpeg concat 文件列表
5. **视频拼接**: 使用 `concat demuxer` 拼接视频（不重编码）
6. **BGM替换**: 替换音频轨道为指定的BGM
7. **清理临时文件**: 自动清理临时目录和文件
8. **输出结果**: 生成最终的视频文件

## 性能优化

- **视频流复制**: 拼接和BGM替换时都使用 `-c:v copy`，避免视频重编码
- **音频重编码**: 只对音频进行必要的重编码（AAC 128k）
- **智能临时目录**: 使用 `视频目录名_temp` 作为临时目录，便于管理和调试
- **自动清理**: 处理完成后自动清理临时文件，节省磁盘空间

## 注意事项

1. **视频兼容性**: 所有选中的视频应该具有相似的编码参数（分辨率、帧率、编码格式）以确保拼接效果
2. **音频长度**: BGM会根据视频总长度自动调整（使用 `-shortest` 参数）
3. **磁盘空间**: 确保有足够的磁盘空间存储临时文件和输出文件
4. **FFmpeg版本**: 建议使用较新版本的 FFmpeg 以获得最佳兼容性

## 错误处理

工具包含完善的错误处理机制：
- 自动验证输入路径和文件格式
- 检查 FFmpeg 可用性
- 处理拼接和BGM替换过程中的错误
- 自动清理临时文件

## 输出信息

程序运行时会显示详细的进度信息：
- 📁 扫描的视频目录
- 📹 找到的视频文件数量
- 🎲 随机选择的视频列表
- 🔗 拼接进度
- 🎵 BGM替换进度
- 📊 最终文件信息

## 许可证

本工具基于现有的视频处理框架开发，遵循相应的开源许可证。